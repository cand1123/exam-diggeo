<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="img.png">
    <title>
        Quiz Management</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for the page */
        body {
            font-family: 'Inter', sans-serif;
        }
        #add-question-form-container {
            transition: opacity 0.3s ease-in-out;
        }
        /* Remove default black border on focus */
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #3b82f6 !important;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-2 sm:p-3 md:p-4 max-w-7xl">
        <!-- Navigation -->
        <nav class="bg-white shadow-lg mb-4">
            <div class="max-w-7xl mx-auto px-3">
                <div class="flex justify-between items-center py-2">
                    <div class="flex items-center space-x-6">
                        <a href="quiz-management.html" class="text-blue-600 font-semibold border-b-2 border-blue-600 pb-1 text-sm">Manajemen Quiz</a>
                        <a href="user-mangement.html" class="text-gray-600 hover:text-blue-600 font-medium transition-colors text-sm">Manajemen Pengguna</a>
                    </div>
                    <div class="flex items-center space-x-3">
                        <a href="mode-admin.html" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 transition-colors duration-200 flex items-center text-sm">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                            </svg>
                            Kembali ke Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Header -->
        <header class="text-left mb-4">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">Manajemen Quiz</h1>
            <p class="text-gray-600 mt-1 text-sm">Kelola soal ujian dan pertanyaan.</p>
        </header>

                          <!-- Add Question Modal (Hidden by default) -->
         <div id="add-question-form-container" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
             <div class="relative p-4 border w-11/12 md:w-3/4 lg:w-2/3 xl:w-1/2 shadow-lg bg-white text-xs">
                 <div class="mt-3">
                     <div class="flex justify-between items-center mb-4">
                         <h3 class="text-xl font-bold text-gray-900">Tambah Soal Baru</h3>
                         <button id="close-add-modal" class="text-gray-400 hover:text-gray-600 text-sm font-bold">×</button>
                     </div>
                     <form id="add-question-form" class="space-y-4">
                        <div>
                            <label class="flex items-center space-x-2 mb-3">
                                <input type="checkbox" id="enable-instruction-case" class="form-checkbox h-4 w-4 text-blue-600">
                                <span class="text-xs font-medium text-gray-700">Apakah ingin menambah instruksi dan studi kasus?</span>
                            </label>
                            <div id="instruction-case-container" class="hidden space-y-4">
                        <div>
                            <label for="instruction" class="block text-xs font-medium text-gray-700 mb-2">Instruksi (Maksimal 30 kata)</label>
                                    <textarea id="instruction" rows="3" class="mt-1 block w-full border border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-xs py-1 px-2 resize-none" placeholder="Jelaskan instruksi singkat untuk menjawab soal ini (maksimal 30 kata)..." maxlength="200"></textarea>
                            <div id="instruction-word-count" class="text-xs text-gray-500 mt-1">0/30 kata</div>
                        </div>
                        <div>
                            <label for="case-description" class="block text-xs font-medium text-gray-700 mb-2">Studi Kasus (Opsional)</label>
                                    <textarea id="case-description" rows="3" class="mt-1 block w-full border border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-xs py-1 px-2 resize-none" placeholder="Jelaskan sebuah skenario atau kasus yang berkaitan dengan pertanyaan ini..."></textarea>
                                </div>
                            </div>
                        </div>
                         <div>
                             <label for="question-text" class="block text-xs font-medium text-gray-700 mb-2">Teks Pertanyaan</label>
                             <textarea id="question-text" rows="3" class="mt-1 block w-full border border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-xs py-1 px-2 resize-none" required></textarea>
                         </div>
                         <div>
                             <label for="question-type" class="block text-xs font-medium text-gray-700 mb-2">Tipe Soal</label>
                             <select id="question-type" class="mt-1 block w-full border border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-xs py-1 px-2">
                                 <option value="multiple_choice">Pilihan Ganda</option>
                                 <option value="true_false">Benar/Salah</option>
                                 <option value="short_answer">Isian Singkat</option>
                                 <option value="matching">Menjodohkan</option>
                             </select>
                         </div>
                         <!-- Dynamic fields for options and answers will be inserted here -->
                         <div id="dynamic-fields-container" class="space-y-3"></div>
                         
                         <div class="flex justify-end space-x-3 pt-2">
                             <button type="button" id="cancel-add-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-1 px-3 text-xs">Batal</button>
                             <button type="submit" id="save-question-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 text-xs">Simpan Soal</button>
                         </div>
                         <p id="form-status" class="text-xs text-center"></p>
                     </form>
                 </div>
             </div>
         </div>

                          <!-- Edit Question Modal (Hidden by default) -->
         <div id="edit-question-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
             <div class="relative p-4 border w-11/12 md:w-3/4 lg:w-2/3 xl:w-1/2 shadow-lg bg-white text-xs">
                 <div class="mt-3">
                     <div class="flex justify-between items-center mb-4">
                         <h3 class="text-xl font-bold text-gray-900">Edit Soal</h3>
                         <button id="close-edit-modal" class="text-gray-400 hover:text-gray-600 text-sm font-bold">×</button>
                     </div>
                     
                     <form id="edit-question-form" class="space-y-4">
                        <input type="hidden" id="edit-question-index">
                        
                        <div>
                            <label class="flex items-center space-x-2 mb-3">
                                <input type="checkbox" id="edit-enable-instruction-case" class="form-checkbox h-4 w-4 text-blue-600">
                                <span class="text-xs font-medium text-gray-700">Apakah ingin menambah instruksi dan studi kasus?</span>
                            </label>
                            <div id="edit-instruction-case-container" class="hidden space-y-4">
                                <div>
                                    <label for="edit-instruction" class="block text-xs font-medium text-gray-700 mb-2">Instruksi (Maksimal 30 kata)</label>
                                    <textarea id="edit-instruction" rows="3" class="mt-1 block w-full border border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-xs py-1 px-2 resize-none" placeholder="Jelaskan instruksi singkat untuk menjawab soal ini (maksimal 30 kata)..." maxlength="200"></textarea>
                                    <div id="edit-instruction-word-count" class="text-xs text-gray-500 mt-1">0/30 kata</div>
                                </div>
                                <div>
                                    <label for="edit-case-description" class="block text-xs font-medium text-gray-700 mb-2">Studi Kasus (Opsional)</label>
                                    <textarea id="edit-case-description" rows="3" class="mt-1 block w-full border border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-xs py-1 px-2 resize-none" placeholder="Jelaskan sebuah skenario atau kasus yang berkaitan dengan pertanyaan ini..."></textarea>
                                </div>
                            </div>
                         </div>
                         
                         <div>
                             <label for="edit-question-text" class="block text-xs font-medium text-gray-700 mb-2">Teks Pertanyaan</label>
                             <textarea id="edit-question-text" rows="3" class="mt-1 block w-full border border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-xs py-1 px-2 resize-none" required></textarea>
                         </div>
                         
                         <div>
                             <label for="edit-question-type" class="block text-xs font-medium text-gray-700 mb-2">Tipe Soal</label>
                             <select id="edit-question-type" class="mt-1 block w-full border border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-xs py-1 px-2">
                                <option value="multiple_choice">Pilihan Ganda</option>
                                <option value="true_false">Benar/Salah</option>
                                <option value="short_answer">Isian Singkat</option>
                                <option value="matching">Menjodohkan</option>
                            </select>
                        </div>
                        
                                                 <!-- Dynamic fields for edit form -->
                         <div id="edit-dynamic-fields-container" class="space-y-3"></div>
                        
                        <div class="flex justify-end space-x-3 pt-2">
                             <button type="button" id="cancel-edit-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-1 px-3 text-xs">Batal</button>
                             <button type="submit" id="update-question-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 text-xs">Update Soal</button>
                         </div>
                        
                        <p id="edit-form-status" class="text-xs text-center"></p>
                    </form>
                </div>
            </div>
        </div>

        <!-- Upload CSV Modal -->
        <div id="upload-csv-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
            <div class="relative p-4 border w-11/12 md:w-3/4 lg:w-2/3 xl:w-1/2 shadow-lg bg-white text-xs">
                <div class="mt-3">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-900">Upload Soal dari CSV</h3>
                        <button id="close-upload-csv-modal" class="text-gray-400 hover:text-gray-600 text-sm font-bold">×</button>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-2">Pilih File CSV</label>
                            <input type="file" id="csv-file-input" accept=".csv" class="mt-1 block w-full border border-gray-300 shadow-sm text-xs py-1 px-2">
                            <p class="text-xs text-gray-500 mt-1">Format CSV: question,type,option1,option2,option3,option4,correct_answer,explanation</p>
                        </div>
                        
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-2">Contoh Format CSV:</label>
                            <div class="bg-gray-50 p-3 text-xs font-mono">
                                <div>question,type,option1,option2,option3,option4,correct_answer,explanation</div>
                                <div>"Apa ibukota Indonesia?","multiple_choice","Jakarta","Surabaya","Bandung","Medan","Jakarta","Jakarta adalah ibukota Indonesia"</div>
                                <div>"Apakah 2+2=4?","true_false","","","","","true","2+2 memang sama dengan 4"</div>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 pt-2">
                            <button type="button" id="cancel-upload-csv-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-1 px-3 text-xs">Batal</button>
                            <button type="button" id="upload-csv-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 text-xs">Upload CSV</button>
                        </div>
                        
                        <p id="csv-upload-status" class="text-xs text-center"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Review Questions Modal -->
        <div id="review-questions-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
            <div class="relative p-4 border w-11/12 md:w-4/5 lg:w-3/4 xl:w-2/3 shadow-lg bg-white text-xs">
                <div class="mt-3">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-900">Review Soal Keseluruhan</h3>
                        <button id="close-review-modal" class="text-gray-400 hover:text-gray-600 text-sm font-bold">×</button>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="bg-gray-50 p-3">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm font-semibold text-gray-700">Total Soal:</span>
                                <span id="total-questions-count" class="text-sm font-bold text-blue-600">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-semibold text-gray-700">Jenis Soal:</span>
                                <div id="question-types-summary" class="text-sm text-gray-600"></div>
                            </div>
                        </div>
                        
                        <div class="max-h-96 overflow-y-auto">
                            <div id="review-questions-container" class="space-y-4"></div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 pt-2">
                            <button type="button" id="close-review-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-1 px-3 text-xs">Tutup</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Review Single Question Modal -->
        <div id="review-single-question-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
            <div class="relative p-4 border w-11/12 md:w-3/4 lg:w-2/3 xl:w-1/2 shadow-lg bg-white text-xs">
                <div class="mt-3">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-900">Review Soal</h3>
                        <button id="close-review-single-modal" class="text-gray-400 hover:text-gray-600 text-sm font-bold">×</button>
                    </div>
                    
                    <div class="space-y-4">
                        <div id="single-question-container" class="space-y-4"></div>
                        
                        <div class="flex justify-end space-x-3 pt-2">
                            <button type="button" id="close-review-single-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-1 px-3 text-xs">Tutup</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <main id="exam-container" class="bg-white p-4 sm:p-6 shadow-lg">
            <!-- Add Question Button -->
            <div class="flex justify-end mb-6 space-x-2">
                <button id="show-add-form-btn" class="bg-green-600 hover:bg-green-700 text-white px-2 py-1 text-xs">
                    Tambah Soal Baru
                </button>
                <button id="show-upload-csv-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 text-xs">
                    Upload CSV
                </button>
                <button id="show-review-btn" class="bg-purple-600 hover:bg-purple-700 text-white px-2 py-1 text-xs">
                    Review Soal
                </button>

            </div>

            <!-- Loading Indicator -->
            <div id="loading" class="text-center py-10">
                <svg class="animate-spin h-8 w-8 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-4 text-gray-600">Memuat soal...</p>
            </div>

            <!-- Questions will be inserted here by JavaScript -->
            <div id="questions-container" class="space-y-8"></div>



            <!-- Result Display -->
            <div id="result-container" class="text-center py-10 hidden">
                <h2 class="text-2xl sm:text-3xl font-bold mb-4 text-gray-900">Hasil Ujian Anda</h2>
                <div id="score" class="text-4xl sm:text-5xl font-bold text-blue-600 bg-blue-50 p-6 inline-block"></div>
                <p id="score-details" class="mt-4 text-lg text-gray-700"></p>
                <button id="restart-btn" class="mt-8 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 transition-transform transform hover:scale-105">
                    Ulangi Ujian
                </button>
            </div>
        </main>

        <!-- Footer -->
        <footer class="text-center mt-auto pt-8 text-gray-500 text-sm">
            <p>&copy; 2024 Platform Ujian CBT</p>
        </footer>
    </div>

    <script type="module">
        // Import Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, get, set, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        // Your web app's Firebase configuration (UPDATED)
        const firebaseConfig = {
            apiKey: "AIzaSyDzHFkgvotq8qb7oC81jDl-WyMgvDgRgyw",
            authDomain: "exam2-df73d.firebaseapp.com",
            databaseURL: "https://exam2-df73d-default-rtdb.firebaseio.com",
            projectId: "exam2-df73d",
            storageBucket: "exam2-df73d.appspot.com",
            messagingSenderId: "1033549838917",
            appId: "1:1033549838917:web:fa6775938004cea9b6c12c",
            measurementId: "G-1TSVFQNHEY"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // DOM Elements
        const loadingEl = document.getElementById('loading');
        const questionsContainer = document.getElementById('questions-container');
        const resultContainer = document.getElementById('result-container');
        const scoreEl = document.getElementById('score');
        const scoreDetailsEl = document.getElementById('score-details');
        const restartBtn = document.getElementById('restart-btn');
        
                 // Add Question Form Elements
         const showAddFormBtn = document.getElementById('show-add-form-btn');
         const addQuestionFormContainer = document.getElementById('add-question-form-container');
         const addQuestionForm = document.getElementById('add-question-form');
         const cancelAddBtn = document.getElementById('cancel-add-btn');
         const closeAddModal = document.getElementById('close-add-modal');
         const questionTypeSelect = document.getElementById('question-type');
         const dynamicFieldsContainer = document.getElementById('dynamic-fields-container');
         const formStatus = document.getElementById('form-status');

        // Edit Question Form Elements
        const editQuestionModal = document.getElementById('edit-question-modal');
        const editQuestionForm = document.getElementById('edit-question-form');
        const closeEditModal = document.getElementById('close-edit-modal');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const editQuestionTypeSelect = document.getElementById('edit-question-type');
        const editDynamicFieldsContainer = document.getElementById('edit-dynamic-fields-container');
        const editFormStatus = document.getElementById('edit-form-status');
        const editQuestionIndex = document.getElementById('edit-question-index');

        // Upload CSV Elements
        const showUploadCsvBtn = document.getElementById('show-upload-csv-btn');
        const uploadCsvModal = document.getElementById('upload-csv-modal');
        const closeUploadCsvModal = document.getElementById('close-upload-csv-modal');
        const cancelUploadCsvBtn = document.getElementById('cancel-upload-csv-btn');
        const csvFileInput = document.getElementById('csv-file-input');
        const uploadCsvBtn = document.getElementById('upload-csv-btn');
        const csvUploadStatus = document.getElementById('csv-upload-status');

        // Review Questions Elements
        const showReviewBtn = document.getElementById('show-review-btn');
        const reviewQuestionsModal = document.getElementById('review-questions-modal');
        const closeReviewModal = document.getElementById('close-review-modal');
        const closeReviewBtn = document.getElementById('close-review-btn');
        const totalQuestionsCount = document.getElementById('total-questions-count');
        const questionTypesSummary = document.getElementById('question-types-summary');
        const reviewQuestionsContainer = document.getElementById('review-questions-container');

        // Review Single Question Elements
        const reviewSingleQuestionModal = document.getElementById('review-single-question-modal');
        const closeReviewSingleModal = document.getElementById('close-review-single-modal');
        const closeReviewSingleBtn = document.getElementById('close-review-single-btn');
        const singleQuestionContainer = document.getElementById('single-question-container');


        let questionsData = [];

        // Function to parse CSV content
        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const questions = [];
            
            // Skip header row
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // Parse CSV line (handle quoted fields)
                const fields = [];
                let currentField = '';
                let inQuotes = false;
                
                for (let j = 0; j < line.length; j++) {
                    const char = line[j];
                    
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        fields.push(currentField.trim());
                        currentField = '';
                    } else {
                        currentField += char;
                    }
                }
                fields.push(currentField.trim());
                
                if (fields.length >= 3) {
                    const question = {
                        question: fields[0],
                        type: fields[1],
                        answer: fields[6] || '',
                        explanation: fields[7] || ''
                    };
                    
                    // Handle different question types
                    if (question.type === 'multiple_choice') {
                        question.options = [
                            fields[2] || '',
                            fields[3] || '',
                            fields[4] || '',
                            fields[5] || ''
                        ].filter(opt => opt !== '');
                    } else if (question.type === 'matching') {
                        // Build pairs from option1..option4 using format "left→right" (fallback '-')
                        const rawOptions = [fields[2], fields[3], fields[4], fields[5]]
                            .filter(v => typeof v === 'string' && v.trim() !== '');
                        const pairs = [];
                        rawOptions.forEach(raw => {
                            const text = raw.replace(/^\"|\"$/g, '').trim();
                            let left = '';
                            let right = '';
                            if (text.includes('→')) {
                                const parts = text.split('→');
                                left = (parts[0] || '').trim();
                                right = (parts[1] || '').trim();
                            } else if (text.includes('-')) {
                                const parts = text.split('-');
                                left = (parts[0] || '').trim();
                                right = (parts[1] || '').trim();
                            }
                            if (left && right) {
                                pairs.push({ left, right });
                            }
                        });
                        question.pairs = pairs;
                    }
                    
                    questions.push(question);
                }
            }
            
            return questions;
        }

        // Function to upload CSV questions
        async function uploadCSVQuestions() {
            const file = csvFileInput.files[0];
            if (!file) {
                csvUploadStatus.textContent = 'Pilih file CSV terlebih dahulu!';
                csvUploadStatus.classList.add('text-red-500');
                return;
            }
            
            csvUploadStatus.textContent = 'Memproses file CSV...';
            csvUploadStatus.classList.remove('text-red-500', 'text-green-500');
            csvUploadStatus.classList.add('text-gray-500');
            
            try {
                const csvText = await file.text();
                const newQuestions = parseCSV(csvText);
                
                if (newQuestions.length === 0) {
                    throw new Error('Tidak ada soal yang valid ditemukan dalam file CSV');
                }
                
                // Fetch current questions and add new ones
                const currentQuestionsSnapshot = await get(ref(database, '/questions'));
                const currentQuestions = currentQuestionsSnapshot.exists() ? currentQuestionsSnapshot.val() : [];
                
                // Add new questions
                const updatedQuestions = [...currentQuestions, ...newQuestions];
                
                // Save to database
                await set(ref(database, '/questions'), updatedQuestions);
                
                csvUploadStatus.textContent = `Berhasil mengupload ${newQuestions.length} soal!`;
                csvUploadStatus.classList.remove('text-gray-500', 'text-red-500');
                csvUploadStatus.classList.add('text-green-500');
                
                // Close modal and refresh
                setTimeout(() => {
                    uploadCsvModal.classList.add('hidden');
                    csvFileInput.value = '';
                    startExam(); // Refresh the exam view
                }, 1500);
                
            } catch (error) {
                console.error("Error uploading CSV:", error);
                csvUploadStatus.textContent = `Gagal mengupload: ${error.message}`;
                csvUploadStatus.classList.remove('text-gray-500', 'text-green-500');
                csvUploadStatus.classList.add('text-red-500');
            }
        }

        // Event listeners for CSV upload
        showUploadCsvBtn.addEventListener('click', () => {
            uploadCsvModal.classList.remove('hidden');
        });

        closeUploadCsvModal.addEventListener('click', () => {
            uploadCsvModal.classList.add('hidden');
            csvFileInput.value = '';
            csvUploadStatus.textContent = '';
        });

        cancelUploadCsvBtn.addEventListener('click', () => {
            uploadCsvModal.classList.add('hidden');
            csvFileInput.value = '';
            csvUploadStatus.textContent = '';
        });

        uploadCsvBtn.addEventListener('click', uploadCSVQuestions);

        // Function to render review questions
        function renderReviewQuestions() {
            if (!Array.isArray(questionsData) || questionsData.length === 0) {
                reviewQuestionsContainer.innerHTML = '<p class="text-center text-gray-500">Belum ada soal untuk direview.</p>';
                return;
            }

            // Update summary
            totalQuestionsCount.textContent = questionsData.length;
            
            // Count question types
            const typeCounts = {};
            questionsData.forEach(q => {
                typeCounts[q.type] = (typeCounts[q.type] || 0) + 1;
            });
            
            const typeSummary = Object.entries(typeCounts)
                .map(([type, count]) => `${getQuestionTypeLabel(type)}: ${count}`)
                .join(', ');
            questionTypesSummary.textContent = typeSummary;

            // Render questions
            reviewQuestionsContainer.innerHTML = '';
            questionsData.forEach((q, index) => {
                const questionEl = document.createElement('div');
                questionEl.className = 'bg-white border border-gray-200 p-4';
                
                let questionType = '';
                switch (q.type) {
                    case 'multiple_choice':
                        questionType = '<span class="px-2 inline-flex text-xs leading-5 font-semibold bg-blue-100 text-blue-800">Pilihan Ganda</span>';
                        break;
                    case 'true_false':
                        questionType = '<span class="px-2 inline-flex text-xs leading-5 font-semibold bg-green-100 text-green-800">Benar/Salah</span>';
                        break;
                    case 'short_answer':
                        questionType = '<span class="px-2 inline-flex text-xs leading-5 font-semibold bg-purple-100 text-purple-800">Jawaban Singkat</span>';
                        break;
                    case 'matching':
                        questionType = '<span class="px-2 inline-flex text-xs leading-5 font-semibold bg-orange-100 text-orange-800">Menjodohkan</span>';
                        break;
                }

                // Add instruction and case description if exists
                let questionText = q.question;
                let hasInstruction = q.instruction;
                let hasCaseDescription = q.caseDescription;
                
                if (hasInstruction || hasCaseDescription) {
                    questionText = `<div>`;
                    
                    // Add instruction if exists
                    if (hasInstruction) {
                        questionText += `
                            <div class="mb-2 p-2 bg-blue-50 border border-blue-200 text-xs text-blue-800">
                                <strong>Instruksi:</strong> ${q.instruction}
                            </div>
                        `;
                    }
                    
                    // Add case description if exists
                    if (hasCaseDescription) {
                        questionText += `
                            <div class="mb-2 p-2 bg-gray-50 border border-gray-200 text-xs text-gray-700">
                                <strong>Studi Kasus:</strong> ${q.caseDescription}
                            </div>
                        `;
                    }
                    
                    questionText += `<div>${q.question}</div></div>`;
                }

                // Generate options display based on question type
                let optionsDisplay = '';
                let correctAnswerDisplay = '';
                
                if (q.type === 'multiple_choice') {
                    // Show all options for multiple choice
                    const options = q.options || [q.option1, q.option2, q.option3, q.option4].filter(opt => opt && opt.trim() !== '');
                    optionsDisplay = '<div class="mt-2"><strong class="text-xs text-gray-600">Pilihan Jawaban:</strong><div class="mt-1 space-y-1">';
                    options.forEach((option, optIndex) => {
                        const isCorrect = option === q.answer;
                        const optionClass = isCorrect ? 'bg-green-50 border-green-200 text-green-800' : 'bg-gray-50 border-gray-200 text-gray-700';
                        const optionLabel = String.fromCharCode(65 + optIndex); // A, B, C, D
                        optionsDisplay += `
                            <div class="p-2 border text-xs ${optionClass}">
                                <span class="font-medium">${optionLabel}.</span> ${option}
                                ${isCorrect ? '<span class="ml-2 text-green-600 font-bold">[BENAR]</span>' : ''}
                            </div>
                        `;
                    });
                    optionsDisplay += '</div></div>';
                    correctAnswerDisplay = ''; // No separate answer box for multiple choice
                    
                } else if (q.type === 'true_false') {
                    optionsDisplay = `
                        <div class="mt-2">
                            <strong class="text-xs text-gray-600">Pilihan Jawaban:</strong>
                            <div class="mt-1 space-y-1">
                                <div class="p-2 border text-xs ${q.answer === 'true' ? 'bg-green-50 border-green-200 text-green-800' : 'bg-gray-50 border-gray-200 text-gray-700'}">
                                    <span class="font-medium">A.</span> Benar
                                    ${q.answer === 'true' ? '<span class="ml-2 text-green-600 font-bold">[BENAR]</span>' : ''}
                                </div>
                                <div class="p-2 border text-xs ${q.answer === 'false' ? 'bg-green-50 border-green-200 text-green-800' : 'bg-gray-50 border-gray-200 text-gray-700'}">
                                    <span class="font-medium">B.</span> Salah
                                    ${q.answer === 'false' ? '<span class="ml-2 text-green-600 font-bold">[BENAR]</span>' : ''}
                                </div>
                            </div>
                        </div>
                    `;
                    correctAnswerDisplay = `<strong>Jawaban Benar:</strong> ${q.answer === 'true' ? 'Benar' : 'Salah'}`;
                    
                } else if (q.type === 'short_answer') {
                    optionsDisplay = '<div class="mt-2"><div class="p-2 bg-gray-50 border border-gray-200 text-xs text-gray-600">Jawaban Singkat - Siswa mengetik jawaban sendiri</div></div>';
                    correctAnswerDisplay = `<strong>Jawaban Benar:</strong> ${q.answer || 'Tidak ada jawaban'}`;
                    
                } else if (q.type === 'matching') {
                    // For matching questions, show pairs
                    const pairs = q.pairs || [];
                    optionsDisplay = '<div class="mt-2"><strong class="text-xs text-gray-600">Pasangan yang Harus Dijodohkan:</strong><div class="mt-1 space-y-1">';
                    pairs.forEach((pair, idx) => {
                        optionsDisplay += `
                            <div class="p-2 bg-gray-50 border border-gray-200 text-xs">
                                <span class="font-medium">${idx + 1}.</span> ${pair.left} → ${pair.right}
                            </div>
                        `;
                    });
                    optionsDisplay += '</div></div>';
                    correctAnswerDisplay = `<strong>Jawaban Benar:</strong> ${q.answer || 'Lihat pasangan di atas'}`;
                }

                questionEl.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center space-x-2">
                            <span class="text-sm font-medium text-gray-900">Soal ${index + 1}</span>
                            ${questionType}
                        </div>
                    </div>
                    <div class="text-sm text-gray-700 mb-3">
                        ${questionText}
                    </div>
                    ${optionsDisplay}
                    ${correctAnswerDisplay ? `<div class="text-xs text-gray-500 mt-2 p-2 bg-blue-50 border border-blue-200">${correctAnswerDisplay}</div>` : ''}
                `;
                
                reviewQuestionsContainer.appendChild(questionEl);
            });
        }

        // Function to get question type label
        function getQuestionTypeLabel(type) {
            const typeLabels = {
                'multiple_choice': 'Pilihan Ganda',
                'true_false': 'Benar/Salah',
                'short_answer': 'Isian Singkat',
                'matching': 'Menjodohkan'
            };
            return typeLabels[type] || type;
        }

        // Event listeners for review modal
        showReviewBtn.addEventListener('click', () => {
            renderReviewQuestions();
            reviewQuestionsModal.classList.remove('hidden');
        });

        closeReviewModal.addEventListener('click', () => {
            reviewQuestionsModal.classList.add('hidden');
        });

        closeReviewBtn.addEventListener('click', () => {
            reviewQuestionsModal.classList.add('hidden');
        });

        // Function to render single question review
        function renderSingleQuestionReview(questionIndex) {
            if (!Array.isArray(questionsData) || questionsData.length === 0 || !questionsData[questionIndex]) {
                singleQuestionContainer.innerHTML = '<p class="text-center text-gray-500">Soal tidak ditemukan.</p>';
                return;
            }

            const q = questionsData[questionIndex];
            singleQuestionContainer.innerHTML = '';

            const questionEl = document.createElement('div');
            questionEl.className = 'bg-white border border-gray-200 rounded-lg p-4';
            
            let questionType = '';
            switch (q.type) {
                case 'multiple_choice':
                    questionType = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">Pilihan Ganda</span>';
                    break;
                case 'true_false':
                    questionType = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Benar/Salah</span>';
                    break;
                case 'short_answer':
                    questionType = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-purple-100 text-purple-800">Jawaban Singkat</span>';
                    break;
                case 'matching':
                    questionType = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-orange-100 text-orange-800">Menjodohkan</span>';
                    break;
            }

            // Add instruction and case description if exists
            let questionText = q.question;
            let hasInstruction = q.instruction;
            let hasCaseDescription = q.caseDescription;
            
            if (hasInstruction || hasCaseDescription) {
                questionText = `<div>`;
                
                // Add instruction if exists
                if (hasInstruction) {
                    questionText += `
                        <div class="mb-2 p-2 bg-blue-50 border-l-4 border-blue-400 rounded-r text-xs">
                            <strong>Instruksi:</strong> ${q.instruction}
                        </div>
                    `;
                }
                
                // Add case description if exists
                if (hasCaseDescription) {
                    questionText += `
                        <div class="mb-2 p-2 bg-gray-50 border-l-4 border-gray-300 rounded-r text-xs">
                            <strong>Studi Kasus:</strong> ${q.caseDescription}
                        </div>
                    `;
                }
                
                questionText += `<div>${q.question}</div></div>`;
            }

            // Generate options display based on question type
            let optionsDisplay = '';
            let correctAnswerDisplay = '';
            
            if (q.type === 'multiple_choice') {
                // Show all options for multiple choice
                const options = q.options || [q.option1, q.option2, q.option3, q.option4].filter(opt => opt && opt.trim() !== '');
                optionsDisplay = '<div class="mt-2"><strong class="text-xs text-gray-600">Pilihan Jawaban:</strong><div class="mt-1 space-y-1">';
                options.forEach((option, optIndex) => {
                    const isCorrect = option === q.answer;
                    const optionClass = isCorrect ? 'bg-green-50 border-green-200 text-green-800' : 'bg-gray-50 border-gray-200 text-gray-700';
                    const optionLabel = String.fromCharCode(65 + optIndex); // A, B, C, D
                    optionsDisplay += `
                        <div class="p-2 border rounded text-xs ${optionClass}">
                            <span class="font-medium">${optionLabel}.</span> ${option}
                            ${isCorrect ? '<span class="ml-2 text-green-600 font-bold">[BENAR]</span>' : ''}
                        </div>
                    `;
                });
                optionsDisplay += '</div></div>';
                correctAnswerDisplay = ''; // No separate answer box for multiple choice
                
            } else if (q.type === 'true_false') {
                optionsDisplay = `
                    <div class="mt-2">
                        <strong class="text-xs text-gray-600">Pilihan Jawaban:</strong>
                        <div class="mt-1 space-y-1">
                            <div class="p-2 border rounded text-xs ${q.answer === 'true' ? 'bg-green-50 border-green-200 text-green-800' : 'bg-gray-50 border-gray-200 text-gray-700'}">
                                <span class="font-medium">A.</span> Benar
                                ${q.answer === 'true' ? '<span class="ml-2 text-green-600 font-bold">[BENAR]</span>' : ''}
                            </div>
                            <div class="p-2 border rounded text-xs ${q.answer === 'false' ? 'bg-green-50 border-green-200 text-green-800' : 'bg-gray-50 border-gray-200 text-gray-700'}">
                                <span class="font-medium">B.</span> Salah
                                ${q.answer === 'false' ? '<span class="ml-2 text-green-600 font-bold">[BENAR]</span>' : ''}
                            </div>
                        </div>
                    </div>
                `;
                correctAnswerDisplay = `<strong>Jawaban Benar:</strong> ${q.answer === 'true' ? 'Benar' : 'Salah'}`;
                
            } else if (q.type === 'short_answer') {
                optionsDisplay = '<div class="mt-2"><div class="p-2 bg-gray-50 border border-gray-200 rounded text-xs text-gray-600">Jawaban Singkat - Siswa mengetik jawaban sendiri</div></div>';
                correctAnswerDisplay = `<strong>Jawaban Benar:</strong> ${q.answer || 'Tidak ada jawaban'}`;
                
            } else if (q.type === 'matching') {
                // For matching questions, show pairs
                const pairs = q.pairs || [];
                optionsDisplay = '<div class="mt-2"><strong class="text-xs text-gray-600">Pasangan yang Harus Dijodohkan:</strong><div class="mt-1 space-y-1">';
                pairs.forEach((pair, idx) => {
                    optionsDisplay += `
                        <div class="p-2 bg-gray-50 border border-gray-200 rounded text-xs">
                            <span class="font-medium">${idx + 1}.</span> ${pair.left} → ${pair.right}
                        </div>
                    `;
                });
                optionsDisplay += '</div></div>';
                correctAnswerDisplay = `<strong>Jawaban Benar:</strong> ${q.answer || 'Lihat pasangan di atas'}`;
            }

            questionEl.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <div class="flex items-center space-x-2">
                        <span class="text-sm font-medium text-gray-900">Soal ${questionIndex + 1}</span>
                        ${questionType}
                    </div>
                </div>
                <div class="text-sm text-gray-700 mb-3">
                    ${questionText}
                </div>
                ${optionsDisplay}
                ${correctAnswerDisplay ? `<div class="text-xs text-gray-500 mt-2 p-2 bg-blue-50 border border-blue-200 rounded">${correctAnswerDisplay}</div>` : ''}
            `;
            
            singleQuestionContainer.appendChild(questionEl);
        }

        // Event listeners for single question review
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('review-single-question-btn')) {
                const questionIndex = parseInt(e.target.dataset.index);
                renderSingleQuestionReview(questionIndex);
                reviewSingleQuestionModal.classList.remove('hidden');
            }
        });

        closeReviewSingleModal.addEventListener('click', () => {
            reviewSingleQuestionModal.classList.add('hidden');
        });

        closeReviewSingleBtn.addEventListener('click', () => {
            reviewSingleQuestionModal.classList.add('hidden');
        });

        // Function to shuffle an array (for matching options)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Function to render questions on the page
        function renderQuestions() {
            questionsContainer.innerHTML = '';
            if (!Array.isArray(questionsData) || questionsData.length === 0) {
                 questionsContainer.innerHTML = `<p class="text-center text-gray-500">Belum ada soal. Silakan tambahkan soal baru.</p>`;
                 return;
            }

            // Create table structure
            let tableContent = `
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead class="bg-white border-b border-gray-200">
                            <tr>
                                <th class="px-1 py-3 text-left text-xs font-medium text-gray-600 w-16">
                                    <div class="flex items-center space-x-1 relative">
                                        <input type="checkbox" id="select-all-checkbox" class="form-checkbox h-4 w-4 text-blue-600 relative group">
                                        <div id="delete-selected-collapse" class="hidden">
                                            <button id="delete-selected-btn" class="text-red-600 hover:text-red-700 p-1 text-xs">
                                                Hapus
                                            </button>
                                        </div>
                                        <div class="absolute left-full ml-1 top-0 bg-white border border-gray-200 shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none z-50 min-w-max">
                                            <div class="px-2 py-1 text-xs text-gray-700 whitespace-nowrap">
                                                Hapus soal terpilih
                                            </div>
                                        </div>
                                    </div>
                                </th>
                                <th class="px-2 py-3 text-left text-xs font-medium text-gray-600 w-12">No</th>
                                <th class="px-2 py-3 text-left text-xs font-medium text-gray-600 w-96">Soal</th>
                                <th class="px-2 py-3 text-left text-xs font-medium text-gray-600 w-24">Jenis</th>
                                <th class="px-2 py-3 text-left text-xs font-medium text-gray-600 w-20">Aksi</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white">
            `;

            questionsData.forEach((q, index) => {
                let questionType = '';

                // Determine question type display
                switch (q.type) {
                    case 'multiple_choice':
                        questionType = '<span class="px-2 py-1 text-xs font-medium bg-blue-50 text-blue-700 border border-blue-200">Pilihan Ganda</span>';
                        break;
                    
                    case 'true_false':
                        questionType = '<span class="px-2 py-1 text-xs font-medium bg-green-50 text-green-700 border border-green-200">Benar/Salah</span>';
                        break;

                    case 'short_answer':
                        questionType = '<span class="px-2 py-1 text-xs font-medium bg-purple-50 text-purple-700 border border-purple-200">Jawaban Singkat</span>';
                        break;
                    
                    case 'matching':
                        questionType = '<span class="px-2 py-1 text-xs font-medium bg-orange-50 text-orange-700 border border-orange-200">Menjodohkan</span>';
                        break;
                }

                // Add instruction and case description if exists
                let questionText = q.question;
                let hasInstruction = q.instruction;
                let hasCaseDescription = q.caseDescription;
                
                if (hasInstruction || hasCaseDescription) {
                    questionText = `<div>`;
                    
                    // Add instruction if exists
                    if (hasInstruction) {
                        questionText += `
                            <div class="mb-2 p-2 bg-blue-50 border border-blue-200 text-xs text-blue-800">
                                <strong>Instruksi:</strong> ${q.instruction}
                            </div>
                        `;
                    }
                    
                    // Add case description if exists
                    if (hasCaseDescription) {
                        questionText += `
                            <div class="mb-2 p-2 bg-gray-50 border border-gray-200 text-xs text-gray-700">
                                <strong>Studi Kasus:</strong> ${q.caseDescription}
                        </div>
                    `;
                    }
                    
                    questionText += `<div>${q.question}</div></div>`;
                }

                                 tableContent += `
                     <tr class="border-b border-gray-100 hover:bg-gray-50">
                         <td class="px-1 py-3 whitespace-nowrap w-16">
                             <input type="checkbox" class="question-select-checkbox form-checkbox h-4 w-4 text-blue-600" data-index="${index}">
                         </td>
                         <td class="px-2 py-3 whitespace-nowrap text-sm font-medium text-gray-900 w-12">
                             ${index + 1}
                         </td>
                         <td class="px-2 py-3 text-sm text-gray-700 w-96">
                             ${questionText}
                         </td>
                         <td class="px-2 py-3 whitespace-nowrap w-24">
                             ${questionType}
                         </td>
                         <td class="px-2 py-3 whitespace-nowrap w-20">
                             <div class="flex flex-col -space-y-1">
                                 <button class="review-single-question-btn bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 text-xs relative z-10 hover:z-20" data-index="${index}">
                                     Review
                                 </button>
                                 <button class="edit-question-btn bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 text-xs relative z-10 hover:z-20" data-index="${index}">
                                     Edit
                                 </button>
                                 <button class="delete-question-btn bg-red-500 hover:bg-red-600 text-white px-2 py-1 text-xs relative z-10 hover:z-20" data-index="${index}">
                                     Hapus
                                 </button>
                             </div>
                         </td>
                     </tr>
                 `;
            });

            tableContent += `
                        </tbody>
                    </table>
                </div>
            `;

            questionsContainer.innerHTML = tableContent;
        }

        // --- Logic for Add Question Form ---

        function updateFormFields() {
            const type = questionTypeSelect.value;
            dynamicFieldsContainer.innerHTML = ''; // Clear previous fields

                         if (type === 'multiple_choice') {
                 dynamicFieldsContainer.innerHTML = `
                     <label class="block text-xs font-medium text-gray-700 mb-3">Opsi Jawaban (Pilih satu sebagai jawaban benar)</label>
                     <div class="grid grid-cols-2 gap-3">
                     ${[0,1,2,3].map(i => `
                             <div class="flex items-center space-x-2">
                             <input type="radio" name="mcq-answer" value="${i}" required class="form-radio h-4 w-4 text-blue-600">
                             <input type="text" placeholder="Opsi ${i + 1}" class="form-input-mcq block w-full border border-gray-300 shadow-sm text-xs py-1 px-2" required>
                         </div>
                     `).join('')}
                     </div>
                 `;
                         } else if (type === 'true_false') {
                 dynamicFieldsContainer.innerHTML = `
                     <label class="block text-xs font-medium text-gray-700 mb-2">Jawaban Benar</label>
                     <select id="tf-answer" class="mt-1 block w-full border border-gray-300 shadow-sm text-xs py-1 px-2">
                         <option value="true">Benar</option>
                         <option value="false">Salah</option>
                     </select>
                 `;
             } else if (type === 'short_answer') {
                 dynamicFieldsContainer.innerHTML = `
                     <label class="block text-xs font-medium text-gray-700 mb-2">Jawaban Benar</label>
                     <input type="text" id="sa-answer" class="mt-1 block w-full border border-gray-300 shadow-sm text-xs py-1 px-2" required placeholder="Jawaban singkat...">
                 `;
                         } else if (type === 'matching') {
                  dynamicFieldsContainer.innerHTML = `
                     <label class="block text-xs font-medium text-gray-700 mb-3">Pasangan</label>
                     <div id="matching-pairs-container" class="space-y-3">
                         <div class="flex items-center space-x-3">
                             <input type="text" placeholder="Item Kiri" class="form-input-match-left block w-full border border-gray-300 shadow-sm text-xs py-1 px-2" required>
                             <span class="text-xs font-medium">-</span>
                             <input type="text" placeholder="Item Kanan" class="form-input-match-right block w-full border border-gray-300 shadow-sm text-xs py-1 px-2" required>
                         </div>
                     </div>
                     <button type="button" id="add-matching-pair-btn" class="text-xs text-blue-600 hover:underline mt-2">+ Tambah Pasangan</button>
                 `;
                                 document.getElementById('add-matching-pair-btn').addEventListener('click', () => {
                     const container = document.getElementById('matching-pairs-container');
                     const newPair = document.createElement('div');
                     newPair.className = 'flex items-center space-x-3';
                     newPair.innerHTML = `
                         <input type="text" placeholder="Item Kiri" class="form-input-match-left block w-full border border-gray-300 shadow-sm text-xs py-1 px-2" required>
                         <span class="text-xs font-medium">-</span>
                         <input type="text" placeholder="Item Kanan" class="form-input-match-right block w-full border border-gray-300 shadow-sm text-xs py-1 px-2" required>
                     `;
                     container.appendChild(newPair);
                 });
            }
        }

        function updateEditFormFields() {
            const type = editQuestionTypeSelect.value;
            editDynamicFieldsContainer.innerHTML = ''; // Clear previous fields

                         if (type === 'multiple_choice') {
                 editDynamicFieldsContainer.innerHTML = `
                     <label class="block text-xs font-medium text-gray-700 mb-3">Opsi Jawaban (Pilih satu sebagai jawaban benar)</label>
                     <div class="grid grid-cols-2 gap-3">
                     ${[0,1,2,3].map(i => `
                             <div class="flex items-center space-x-2">
                             <input type="radio" name="edit-mcq-answer" value="${i}" required class="form-radio h-4 w-4 text-blue-600">
                             <input type="text" placeholder="Opsi ${i + 1}" class="edit-form-input-mcq block w-full border border-gray-300 shadow-sm text-xs py-1 px-2" required>
                         </div>
                     `).join('')}
                     </div>
                 `;
                         } else if (type === 'true_false') {
                 editDynamicFieldsContainer.innerHTML = `
                     <label class="block text-xs font-medium text-gray-700 mb-2">Jawaban Benar</label>
                     <select id="edit-tf-answer" class="mt-1 block w-full border border-gray-300 shadow-sm text-xs py-1 px-2">
                         <option value="true">Benar</option>
                         <option value="false">Salah</option>
                     </select>
                 `;
             } else if (type === 'short_answer') {
                 editDynamicFieldsContainer.innerHTML = `
                     <label class="block text-xs font-medium text-gray-700 mb-2">Jawaban Benar</label>
                     <input type="text" id="edit-sa-answer" class="mt-1 block w-full border border-gray-300 shadow-sm text-xs py-1 px-2" required placeholder="Jawaban singkat...">
                 `;
                         } else if (type === 'matching') {
                  editDynamicFieldsContainer.innerHTML = `
                     <label class="block text-xs font-medium text-gray-700 mb-3">Pasangan</label>
                     <div id="edit-matching-pairs-container" class="space-y-3">
                         <div class="flex items-center space-x-3">
                             <input type="text" placeholder="Item Kiri" class="edit-form-input-match-left block w-full border border-gray-300 shadow-sm text-xs py-1 px-2" required>
                             <span class="text-xs font-medium">-</span>
                             <input type="text" placeholder="Item Kanan" class="edit-form-input-match-right block w-full border border-gray-300 shadow-sm text-xs py-1 px-2" required>
                         </div>
                     </div>
                     <button type="button" id="edit-add-matching-pair-btn" class="text-xs text-blue-600 hover:underline mt-2">+ Tambah Pasangan</button>
                 `;
                                 document.getElementById('edit-add-matching-pair-btn').addEventListener('click', () => {
                     const container = document.getElementById('edit-matching-pairs-container');
                     const newPair = document.createElement('div');
                     newPair.className = 'flex items-center space-x-3';
                     newPair.innerHTML = `
                         <input type="text" placeholder="Item Kiri" class="edit-form-input-match-left block w-full border border-gray-300 shadow-sm text-xs py-1 px-2" required>
                         <span class="text-xs font-medium">-</span>
                         <input type="text" placeholder="Item Kanan" class="edit-form-input-match-right block w-full border border-gray-300 shadow-sm text-xs py-1 px-2" required>
                     `;
                     container.appendChild(newPair);
                 });
            }
        }
        
                 showAddFormBtn.addEventListener('click', () => {
             addQuestionFormContainer.classList.remove('hidden');
             // Reset checkbox
             enableInstructionCaseCheckbox.checked = false;
             instructionCaseContainer.classList.add('hidden');
             updateFormFields();
         });

         // Function to update delete button visibility
         function updateDeleteButtonVisibility() {
             const selectedCheckboxes = document.querySelectorAll('.question-select-checkbox:checked');
             const deleteCollapse = document.getElementById('delete-selected-collapse');
             
             if (selectedCheckboxes.length > 0) {
                 deleteCollapse.classList.remove('hidden');
             } else {
                 deleteCollapse.classList.add('hidden');
             }
         }

         // Select all checkbox functionality
         document.addEventListener('change', function(e) {
             if (e.target.id === 'select-all-checkbox') {
                 const checkboxes = document.querySelectorAll('.question-select-checkbox');
                 checkboxes.forEach(checkbox => {
                     checkbox.checked = e.target.checked;
                 });
                 updateDeleteButtonVisibility();
             }
             
             // Handle individual checkbox changes
             if (e.target.classList.contains('question-select-checkbox')) {
                 updateDeleteButtonVisibility();
                 
                 // Update select all checkbox state
                 const allCheckboxes = document.querySelectorAll('.question-select-checkbox');
                 const checkedCheckboxes = document.querySelectorAll('.question-select-checkbox:checked');
                 const selectAllCheckbox = document.getElementById('select-all-checkbox');
                 
                 if (checkedCheckboxes.length === 0) {
                     selectAllCheckbox.indeterminate = false;
                     selectAllCheckbox.checked = false;
                 } else if (checkedCheckboxes.length === allCheckboxes.length) {
                     selectAllCheckbox.indeterminate = false;
                     selectAllCheckbox.checked = true;
                 } else {
                     selectAllCheckbox.indeterminate = true;
                 }
             }
         });

         // Delete selected questions (using event delegation)
         document.addEventListener('click', function(e) {
             if (e.target.id === 'delete-selected-btn') {
                 const selectedCheckboxes = document.querySelectorAll('.question-select-checkbox:checked');
                 
                 if (selectedCheckboxes.length === 0) {
                     alert('Pilih minimal satu soal untuk dihapus!');
                     return;
                 }

                 const confirmMessage = `Apakah Anda yakin ingin menghapus ${selectedCheckboxes.length} soal yang dipilih?`;
                 if (confirm(confirmMessage)) {
                     // Get indices of selected questions (in descending order to avoid index shifting)
                     const indicesToDelete = Array.from(selectedCheckboxes)
                         .map(cb => parseInt(cb.dataset.index))
                         .sort((a, b) => b - a);

                     // Delete questions from Firebase by filtering out selected indices
                     const updatedQuestions = questionsData.filter((_, index) => !indicesToDelete.includes(index));
                     console.log('Original questions count:', questionsData.length);
                     console.log('Updated questions count:', updatedQuestions.length);
                     console.log('Indices to delete:', indicesToDelete);
                     
                     // Save updated questions array to Firebase
                     set(ref(database, '/questions'), updatedQuestions)
                         .then(() => {
                             alert(`${selectedCheckboxes.length} soal berhasil dihapus!`);
                             // Hide delete button after successful deletion
                             document.getElementById('delete-selected-collapse').classList.add('hidden');
                             startExam(); // Reload the questions
                         })
                         .catch(error => {
                             console.error('Error deleting questions:', error);
                             console.error('Error details:', error.message);
                             console.error('Error code:', error.code);
                             alert(`Terjadi kesalahan saat menghapus soal: ${error.message}`);
                         });
                 }
             }
         });

         cancelAddBtn.addEventListener('click', () => {
             addQuestionForm.reset();
             addQuestionFormContainer.classList.add('hidden');
             formStatus.textContent = '';
         });

         closeAddModal.addEventListener('click', () => {
             addQuestionForm.reset();
             addQuestionFormContainer.classList.add('hidden');
             formStatus.textContent = '';
         });

        questionTypeSelect.addEventListener('change', updateFormFields);
        editQuestionTypeSelect.addEventListener('change', updateEditFormFields);

        // Checkbox toggle functionality
        const enableInstructionCaseCheckbox = document.getElementById('enable-instruction-case');
        const instructionCaseContainer = document.getElementById('instruction-case-container');

        const editEnableInstructionCaseCheckbox = document.getElementById('edit-enable-instruction-case');
        const editInstructionCaseContainer = document.getElementById('edit-instruction-case-container');

        // Add form checkbox handler
        enableInstructionCaseCheckbox.addEventListener('change', function() {
            if (this.checked) {
                instructionCaseContainer.classList.remove('hidden');
            } else {
                instructionCaseContainer.classList.add('hidden');
                document.getElementById('instruction').value = '';
                document.getElementById('case-description').value = '';
                document.getElementById('instruction-word-count').textContent = '0/30 kata';
            }
        });

        // Edit form checkbox handler
        editEnableInstructionCaseCheckbox.addEventListener('change', function() {
            if (this.checked) {
                editInstructionCaseContainer.classList.remove('hidden');
            } else {
                editInstructionCaseContainer.classList.add('hidden');
                document.getElementById('edit-instruction').value = '';
                document.getElementById('edit-case-description').value = '';
                document.getElementById('edit-instruction-word-count').textContent = '0/30 kata';
            }
        });

        // Word count validation for instruction
        const instructionTextarea = document.getElementById('instruction');
        const instructionWordCountDisplay = document.getElementById('instruction-word-count');
        
        instructionTextarea.addEventListener('input', function() {
            const text = this.value.trim();
            const wordCount = text ? text.split(/\s+/).length : 0;
            instructionWordCountDisplay.textContent = `${wordCount}/30 kata`;
            
            if (wordCount > 30) {
                instructionWordCountDisplay.className = 'text-xs text-red-500 mt-1';
                instructionWordCountDisplay.textContent = `${wordCount}/30 kata (Melebihi batas!)`;
            } else {
                instructionWordCountDisplay.className = 'text-xs text-gray-500 mt-1';
            }
        });

        // Word count validation for edit instruction
        const editInstructionTextarea = document.getElementById('edit-instruction');
        const editInstructionWordCountDisplay = document.getElementById('edit-instruction-word-count');
        
        editInstructionTextarea.addEventListener('input', function() {
            const text = this.value.trim();
            const wordCount = text ? text.split(/\s+/).length : 0;
            editInstructionWordCountDisplay.textContent = `${wordCount}/30 kata`;
            
            if (wordCount > 30) {
                editInstructionWordCountDisplay.className = 'text-xs text-red-500 mt-1';
                editInstructionWordCountDisplay.textContent = `${wordCount}/30 kata (Melebihi batas!)`;
            } else {
                editInstructionWordCountDisplay.className = 'text-xs text-gray-500 mt-1';
            }
        });

        // Function to populate edit form with existing question data
        function populateEditForm(questionIndex) {
            const question = questionsData[questionIndex];
            editQuestionIndex.value = questionIndex;
            
            // Fill basic fields
            document.getElementById('edit-question-text').value = question.question;
            document.getElementById('edit-question-type').value = question.type;
            
            // Handle instruction and case description checkbox and fields
            if (question.instruction || question.caseDescription) {
                editEnableInstructionCaseCheckbox.checked = true;
                editInstructionCaseContainer.classList.remove('hidden');
                document.getElementById('edit-instruction').value = question.instruction || '';
                document.getElementById('edit-case-description').value = question.caseDescription || '';
            } else {
                editEnableInstructionCaseCheckbox.checked = false;
                editInstructionCaseContainer.classList.add('hidden');
                document.getElementById('edit-instruction').value = '';
                document.getElementById('edit-case-description').value = '';
            }
            
            // Update form fields based on type
            updateEditFormFields();
            
            // Fill specific fields based on question type
            setTimeout(() => {
                if (question.type === 'multiple_choice') {
                    const optionInputs = document.querySelectorAll('.edit-form-input-mcq');
                    const answerRadio = document.querySelector(`input[name="edit-mcq-answer"][value="${question.options.indexOf(question.answer)}"]`);
                    
                    question.options.forEach((option, i) => {
                        if (optionInputs[i]) {
                            optionInputs[i].value = option;
                        }
                    });
                    
                    if (answerRadio) {
                        answerRadio.checked = true;
                    }
                } else if (question.type === 'true_false') {
                    document.getElementById('edit-tf-answer').value = String(question.answer);
                } else if (question.type === 'short_answer') {
                    document.getElementById('edit-sa-answer').value = question.answer;
                } else if (question.type === 'matching') {
                    const leftInputs = document.querySelectorAll('.edit-form-input-match-left');
                    const rightInputs = document.querySelectorAll('.edit-form-input-match-right');
                    
                    // Clear existing pairs and add new ones
                    const container = document.getElementById('edit-matching-pairs-container');
                    container.innerHTML = '';
                    
                                         question.pairs.forEach((pair, i) => {
                         const pairDiv = document.createElement('div');
                         pairDiv.className = 'flex items-center space-x-3';
                         pairDiv.innerHTML = `
                             <input type="text" value="${pair.left}" class="edit-form-input-match-left block w-full border border-gray-300 shadow-sm text-xs py-1 px-2" required>
                             <span class="text-xs font-medium">-</span>
                             <input type="text" value="${pair.right}" class="edit-form-input-match-right block w-full border border-gray-300 shadow-sm text-xs py-1 px-2" required>
                         `;
                         container.appendChild(pairDiv);
                     });
                }
            }, 100);
        }

        // Event listeners for edit functionality
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('edit-question-btn')) {
                const questionIndex = parseInt(e.target.dataset.index);
                populateEditForm(questionIndex);
                editQuestionModal.classList.remove('hidden');
            }
            
            if (e.target.classList.contains('delete-question-btn')) {
                const questionIndex = parseInt(e.target.dataset.index);
                if (confirm('Apakah Anda yakin ingin menghapus soal ini?')) {
                    deleteQuestion(questionIndex);
                }
            }
        });

        // Close edit modal
        closeEditModal.addEventListener('click', () => {
            editQuestionModal.classList.add('hidden');
        });

        cancelEditBtn.addEventListener('click', () => {
            editQuestionModal.classList.add('hidden');
        });

        // Function to delete question
        async function deleteQuestion(questionIndex) {
            try {
                const updatedQuestions = questionsData.filter((_, index) => index !== questionIndex);
                await set(ref(database, '/questions'), updatedQuestions);
                questionsData = updatedQuestions;
                renderQuestions();
            } catch (error) {
                console.error("Error deleting question:", error);
                alert('Gagal menghapus soal: ' + error.message);
            }
        }

        addQuestionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            formStatus.textContent = 'Menyimpan...';
            formStatus.classList.remove('text-red-500', 'text-green-500');
            formStatus.classList.add('text-gray-500');

            const newQuestion = {
                type: questionTypeSelect.value,
                question: document.getElementById('question-text').value.trim()
            };

            // Handle instruction and case description fields
            if (enableInstructionCaseCheckbox.checked) {
            const instruction = document.getElementById('instruction').value.trim();
            if (instruction) {
                const wordCount = instruction.split(/\s+/).length;
                if (wordCount > 30) {
                    throw new Error("Instruksi tidak boleh melebihi 30 kata. Saat ini: " + wordCount + " kata.");
                }
                newQuestion.instruction = instruction;
            }

            const caseDescription = document.getElementById('case-description').value.trim();
            if (caseDescription) {
                newQuestion.caseDescription = caseDescription;
                }
            }

            try {
                switch (newQuestion.type) {
                    case 'multiple_choice':
                        const options = Array.from(document.querySelectorAll('.form-input-mcq')).map(input => input.value.trim());
                        const answerIndex = document.querySelector('input[name="mcq-answer"]:checked').value;
                        newQuestion.options = options;
                        newQuestion.answer = options[answerIndex];
                        if (options.some(opt => opt === '') || !newQuestion.answer) throw new Error("Semua opsi dan jawaban harus diisi.");
                        break;
                    case 'true_false':
                        newQuestion.answer = document.getElementById('tf-answer').value === 'true';
                        break;
                    case 'short_answer':
                        newQuestion.answer = document.getElementById('sa-answer').value.trim();
                        if (newQuestion.answer === '') throw new Error("Jawaban harus diisi.");
                        break;
                    case 'matching':
                        const lefts = Array.from(document.querySelectorAll('.form-input-match-left')).map(i => i.value.trim());
                        const rights = Array.from(document.querySelectorAll('.form-input-match-right')).map(i => i.value.trim());
                        if (lefts.some(v => v === '') || rights.some(v => v === '')) throw new Error("Semua item pasangan harus diisi.");
                        newQuestion.pairs = lefts.map((left, i) => ({ left, right: rights[i] }));
                        break;
                }

                // Fetch current questions, add the new one, and set it back
                const currentQuestionsSnapshot = await get(ref(database, '/questions'));
                const currentQuestions = currentQuestionsSnapshot.exists() ? currentQuestionsSnapshot.val() : [];
                currentQuestions.push(newQuestion);
                
                await set(ref(database, '/questions'), currentQuestions);

                formStatus.textContent = 'Soal berhasil disimpan!';
                formStatus.classList.add('text-green-500');

                                 setTimeout(() => {
                     addQuestionForm.reset();
                     addQuestionFormContainer.classList.add('hidden');
                     startExam(); // Refresh the exam view
                 }, 1000);

            } catch (error) {
                console.error("Error saving question:", error);
                formStatus.textContent = `Gagal menyimpan: ${error.message}`;
                formStatus.classList.add('text-red-500');
            }
        });

        // Edit Question Form Submit Handler
        editQuestionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            editFormStatus.textContent = 'Menyimpan perubahan...';
            editFormStatus.classList.remove('text-red-500', 'text-green-500');
            editFormStatus.classList.add('text-gray-500');

            const questionIndex = parseInt(editQuestionIndex.value);
            const updatedQuestion = {
                type: editQuestionTypeSelect.value,
                question: document.getElementById('edit-question-text').value.trim()
            };

            // Handle instruction and case description fields
            if (editEnableInstructionCaseCheckbox.checked) {
                const instruction = document.getElementById('edit-instruction').value.trim();
                if (instruction) {
                    const wordCount = instruction.split(/\s+/).length;
                    if (wordCount > 30) {
                        editFormStatus.textContent = `Instruksi tidak boleh melebihi 30 kata. Saat ini: ${wordCount} kata.`;
                        editFormStatus.classList.add('text-red-500');
                        return;
                    }
                    updatedQuestion.instruction = instruction;
                }

            const caseDescription = document.getElementById('edit-case-description').value.trim();
            if (caseDescription) {
                updatedQuestion.caseDescription = caseDescription;
                }
            }

            try {
                switch (updatedQuestion.type) {
                    case 'multiple_choice':
                        const options = Array.from(document.querySelectorAll('.edit-form-input-mcq')).map(input => input.value.trim());
                        const answerIndex = document.querySelector('input[name="edit-mcq-answer"]:checked').value;
                        updatedQuestion.options = options;
                        updatedQuestion.answer = options[answerIndex];
                        if (options.some(opt => opt === '') || !updatedQuestion.answer) throw new Error("Semua opsi dan jawaban harus diisi.");
                        break;
                    case 'true_false':
                        updatedQuestion.answer = document.getElementById('edit-tf-answer').value === 'true';
                        break;
                    case 'short_answer':
                        updatedQuestion.answer = document.getElementById('edit-sa-answer').value.trim();
                        if (updatedQuestion.answer === '') throw new Error("Jawaban harus diisi.");
                        break;
                    case 'matching':
                        const lefts = Array.from(document.querySelectorAll('.edit-form-input-match-left')).map(i => i.value.trim());
                        const rights = Array.from(document.querySelectorAll('.edit-form-input-match-right')).map(i => i.value.trim());
                        if (lefts.some(v => v === '') || rights.some(v => v === '')) throw new Error("Semua item pasangan harus diisi.");
                        updatedQuestion.pairs = lefts.map((left, i) => ({ left, right: rights[i] }));
                        break;
                }

                // Update the question in the array
                questionsData[questionIndex] = updatedQuestion;
                
                // Save to database
                await set(ref(database, '/questions'), questionsData);

                editFormStatus.textContent = 'Soal berhasil diperbarui!';
                editFormStatus.classList.add('text-green-500');

                setTimeout(() => {
                    editQuestionModal.classList.add('hidden');
                    renderQuestions(); // Refresh the display
                }, 1000);

            } catch (error) {
                console.error("Error updating question:", error);
                editFormStatus.textContent = `Gagal memperbarui: ${error.message}`;
                editFormStatus.classList.add('text-red-500');
            }
        });

        // --- End of Add Question Form Logic ---


        // Function to calculate the score
        function calculateScore() {
            let score = 0;
            let correctAnswers = 0;

            questionsData.forEach((q, index) => {
                let isCorrect = false;
                switch (q.type) {
                    case 'multiple_choice': {
                        const selected = document.querySelector(`input[name="question-${index}"]:checked`);
                        if (selected && selected.value === q.answer) isCorrect = true;
                        break;
                    }
                    case 'true_false': {
                        const selected = document.querySelector(`input[name="question-${index}"]:checked`);
                        if (selected && (selected.value === String(q.answer))) isCorrect = true;
                        break;
                    }
                    case 'short_answer': {
                        const input = document.querySelector(`input[name="question-${index}"]`);
                        if (input && input.value.trim().toLowerCase() === q.answer.toLowerCase()) isCorrect = true;
                        break;
                    }
                    case 'matching': {
                        let allPairsCorrect = true;
                        q.pairs.forEach((pair, pairIndex) => {
                            const select = document.querySelector(`select[name="question-${index}-${pairIndex}"]`);
                            if (!select || select.value !== pair.right) allPairsCorrect = false;
                        });
                        if(allPairsCorrect) isCorrect = true;
                        break;
                    }
                }
                if(isCorrect) correctAnswers++;
            });
            
            score = Math.round((correctAnswers / questionsData.length) * 100);
            return { score, correctAnswers, total: questionsData.length };
        }


        
        restartBtn.addEventListener('click', () => {
            resultContainer.classList.add('hidden');
            startExam(); // Re-fetch and render questions
        });

        // Main function to fetch data and start the exam
        async function startExam() {
            loadingEl.classList.remove('hidden');
            questionsContainer.innerHTML = '';
            
            try {
                // IMPORTANT: Your Firebase Realtime Database rules must allow public read/write.
                // { "rules": { ".read": true, ".write": true } }
                // This is insecure for production. For a real app, use authentication.

                const snapshot = await get(ref(database, '/questions'));
                if (snapshot.exists()) {
                    questionsData = snapshot.val();
                } else {
                    questionsData = []; // No questions exist yet
                }
                renderQuestions();
                
            } catch (error) {
                console.error("Error during exam startup: ", error);
                questionsContainer.innerHTML = `<p class="text-red-500 font-semibold text-center">Gagal memuat soal. Pastikan aturan keamanan Firebase memperbolehkan akses baca. <br><small>${error.message}</small></p>`;
            } finally {
                loadingEl.classList.add('hidden');
            }
        }

        // Initial load
        startExam();
    </script>
</body>
</html>
