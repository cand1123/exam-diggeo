<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Form</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Use Inter font family */
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-xl shadow-lg">
        <h1 class="text-3xl font-bold text-center text-gray-800">Selamat Datang</h1>
        <p class="text-center text-gray-500">Silakan login untuk melanjutkan</p>

        <!-- Login Form -->
        <form id="loginForm" class="space-y-6">
            <div>
                <label for="username" class="text-sm font-medium text-gray-700">Username</label>
                <input type="text" id="username" name="username" required
                    class="w-full px-4 py-2 mt-2 text-gray-700 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-300">
            </div>
            <div>
                <label for="password" class="text-sm font-medium text-gray-700">Password</label>
                <input type="password" id="password" name="password" required
                    class="w-full px-4 py-2 mt-2 text-gray-700 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-300">
            </div>
            <div>
                <button type="submit" id="loginButton"
                    class="w-full px-4 py-2 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300 flex items-center justify-center">
                    <span id="buttonText">Login</span>
                    <!-- Spinner for loading state -->
                    <svg id="spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </div>
        </form>

        <!-- Message container for success/error alerts -->
        <div id="message" class="text-center text-sm font-medium"></div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import functions from the Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getDatabase, ref, get, child } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

        // Cek apakah user sudah login saat halaman dimuat
        document.addEventListener('DOMContentLoaded', function() {
            const currentUser = sessionStorage.getItem('currentUser');
            if (currentUser) {
                try {
                    const user = JSON.parse(currentUser);
                    if (user.userType === 'student') {
                        window.location.href = 'student-exam.html';
                    } else {
                        window.location.href = 'mode-admin.html';
                    }
                } catch (error) {
                    console.error('Error parsing user data:', error);
                    sessionStorage.removeItem('currentUser');
                }
            }
        });

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyASnGEE-S_-1GfsqitrV26KVbUGCKLRxW8",
            authDomain: "test-login-e3c51.firebaseapp.com",
            databaseURL: "https://test-login-e3c51-default-rtdb.firebaseio.com",
            projectId: "test-login-e3c51",
            storageBucket: "test-login-e3c51.appspot.com",
            messagingSenderId: "410742520241",
            appId: "1:410742520241:web:b801fe48e29f9a0e01a590",
            measurementId: "G-2LKPSMCB6B"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Get form and UI elements
        const loginForm = document.getElementById('loginForm');
        const messageDiv = document.getElementById('message');
        const loginButton = document.getElementById('loginButton');
        const buttonText = document.getElementById('buttonText');
        const spinner = document.getElementById('spinner');

        // --- SECURITY WARNING ---
        // Menyimpan password dalam bentuk teks biasa di database SANGAT TIDAK AMAN.
        // Pada aplikasi nyata, Anda HARUS menggunakan Firebase Authentication.

        // Add event listener for form submission
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault(); // Prevent default form submission

            // Get user input
            const usernameInput = document.getElementById('username').value;
            const passwordInput = document.getElementById('password').value;

            // Show loading state
            setLoading(true);
            messageDiv.textContent = ''; // Clear previous messages

            try {
                // Assuming your array is at the root of your database or under a specific key.
                // If your array is under a key, e.g., "users", change it to `ref(db, 'users')`
                const dbRef = ref(db); 
                const snapshot = await get(dbRef);

                if (snapshot.exists()) {
                    const usersArray = snapshot.val();
                    
                    // Check if data is an array and not empty
                    if (Array.isArray(usersArray) && usersArray.length > 0) {
                        
                        // Find a user in the array that matches the credentials
                        const foundUser = usersArray.find(user => 
                            user && // ensure user object is not null/undefined
                            user.Username === usernameInput && 
                            user.Password === passwordInput
                        );

                        if (foundUser) {
                            // If user is found, show success message and redirect
                            const displayName = foundUser["Full Name"] || foundUser.Username;
                            showMessage(`Login berhasil! Selamat datang, ${displayName}.`, 'success');
                            
                            // Simpan data user ke sessionStorage
                            const userData = {
                                username: foundUser.Username,
                                fullName: foundUser["Full Name"],
                                userType: foundUser.Role || 'admin', // Default ke admin jika tidak ada role
                                class: foundUser.Class || 'Admin'
                            };
                            sessionStorage.setItem('currentUser', JSON.stringify(userData));
                            
                            // Redirect berdasarkan role
                            setTimeout(() => {
                                if (foundUser.Role === 'student') {
                                    window.location.href = 'student-exam.html';
                                } else {
                                    window.location.href = 'mode-admin.html';
                                }
                            }, 1500);
                        } else {
                            // If no user matches
                            showMessage('Username atau password salah.', 'error');
                        }

                    } else {
                         showMessage('Format data pengguna tidak valid atau kosong.', 'error');
                    }

                } else {
                    showMessage('Database tidak ditemukan atau kosong.', 'error');
                }
            } catch (error) {
                console.error("Error saat login: ", error);
                showMessage('Terjadi kesalahan. Silakan coba lagi.', 'error');
            } finally {
                // Hide loading state
                setLoading(false);
            }
        });

        /**
         * Displays a message to the user.
         * @param {string} text - The message to display.
         * @param {string} type - The type of message ('success' or 'error').
         */
        function showMessage(text, type) {
            messageDiv.textContent = text;
            if (type === 'success') {
                messageDiv.className = 'text-green-600 text-center text-sm font-medium';
            } else {
                messageDiv.className = 'text-red-600 text-center text-sm font-medium';
            }
        }

        /**
         * Toggles the loading state of the login button.
         * @param {boolean} isLoading - True to show spinner, false to hide.
         */
        function setLoading(isLoading) {
            if (isLoading) {
                loginButton.disabled = true;
                buttonText.classList.add('hidden');
                spinner.classList.remove('hidden');
            } else {
                loginButton.disabled = false;
                buttonText.classList.remove('hidden');
                spinner.classList.add('hidden');
            }
        }

    </script>
</body>
</html>
